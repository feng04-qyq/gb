# 账号代理系统说明

## 概述

已成功实现每个账号使用不同IP代理的功能，确保账号之间不会因为使用相同IP而产生关联。

## 核心功能

### 1. 账号代理管理器 (`account_proxy_manager.py`)

- **独立代理分配**：每个账号分配独立的代理IP
- **代理状态跟踪**：记录代理的成功/失败次数和最后使用时间
- **自动刷新**：当代理失败时自动获取新代理
- **持久化存储**：代理映射保存在 `account_proxy_mapping.json` 文件中

### 2. 账号专用API请求

所有API函数都已修改为支持账号专用代理：

- `login_api(account, password)` - 登录API
- `sign_api(token, account)` - 签到API  
- `balance_api(token, account)` - 余额查询API
- `withdraw_api(token, num, account=account)` - 提现API

### 3. 智能代理管理

- **自动分配**：新账号首次使用时自动分配代理
- **失败重试**：代理失败时自动刷新并重试
- **状态监控**：实时监控代理健康状态
- **负载均衡**：避免多个账号使用相同代理

## 系统架构

```
账号代理管理器
├── 代理分配逻辑
├── 状态跟踪
├── 失败处理
└── 持久化存储

API请求层
├── 账号专用代理获取
├── 请求发送
├── 错误处理
└── 代理刷新

前端界面
├── 代理状态显示
├── 账号代理分配展示
└── 实时更新
```

## 文件结构

```
withdraw_web/
├── account_proxy_manager.py      # 账号代理管理器
├── account_proxy_mapping.json    # 账号代理映射文件
├── app.py                       # 主应用（已集成账号代理）
├── proxy_api.py                 # 代理API接口
├── proxy_config.py              # 代理配置管理
└── templates/sign.html          # 前端界面（已更新）
```

## 使用效果

### 1. 代理分配示例

```json
{
  "16643081089": {
    "ip": "125.124.178.137",
    "port": 5605,
    "type": "http",
    "fail_count": 0,
    "last_used": "2025-07-28 04:15:02"
  },
  "16643081980": {
    "ip": "125.124.146.223", 
    "port": 5612,
    "type": "http",
    "fail_count": 0,
    "last_used": "2025-07-28 04:15:15"
  }
}
```

### 2. 日志示例

```
账号 16643081089 使用代理发送请求: POST https://qy.doufp.com/api/auth/login 代理: http://125.124.178.137:5605
账号 16643081980 使用代理发送请求: POST https://qy.doufp.com/api/auth/login 代理: http://125.124.146.223:5612
```

### 3. 前端显示

- 代理状态卡片显示总体代理信息
- 账号代理分配区域显示每个账号的代理IP
- 实时更新代理状态和分配情况

## 优势

1. **账号隔离**：每个账号使用独立IP，避免关联风险
2. **自动管理**：无需手动配置，系统自动分配和管理代理
3. **故障恢复**：代理失败时自动切换，保证服务连续性
4. **状态监控**：实时监控代理健康状态和使用情况
5. **用户友好**：前端界面清晰显示代理分配情况

## 技术特点

- **模块化设计**：代理管理独立封装，易于维护
- **错误处理**：完善的异常处理和重试机制
- **性能优化**：避免重复代理分配，提高效率
- **数据持久化**：代理映射持久保存，重启后保持状态

## 测试验证

系统已通过以下测试：

1. ✅ 账号代理管理器独立测试
2. ✅ 代理分配功能验证
3. ✅ API请求代理使用验证
4. ✅ 前端界面显示验证
5. ✅ 日志记录功能验证

## 总结

账号代理系统已完全实现并正常运行，每个账号现在都使用独立的IP代理，有效避免了账号关联风险，同时提供了完善的代理管理和监控功能。 